<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{ app_name }} — Admin</title>
  <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
  <link rel="manifest" href="/static/site.webmanifest">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
  <style>
    /* A simple, text-focused, and functional stylesheet */
    body {
      font-family: Consolas, Monaco, "Andale Mono", "Ubuntu Mono", monospace;
      background-color: #f5f5f5;
      color: #111;
      margin: 0;
      padding: 1em;
    }

    /* --- CHANGE 1: Make base elements and container responsive --- */
    * {
        box-sizing: border-box; /* A good practice for easier layout math */
    }

    /* Layout */
    h1, h2, h3 { margin: 1em 0 0.5em 0; }
    hr { border: none; border-top: 1px solid #ccc; margin: 2em 0; }
    fieldset {
      border: 1px solid #ccc;
      padding: 1em;
      margin-bottom: 1em;
    }
    legend {
      font-weight: bold;
      padding: 0 0.5em;
    }
    .hidden { display: none !important; }

    .container {
      max-width: 900px;
      width: 100%; /* Allow the container to shrink on smaller screens */
      margin: 0 auto;
      background-color: #fff;
      border: 1px solid #ccc;
      padding: 1em 2em;
    }

    /* --- CHANGE 2: Make form inputs responsive --- */
    input[type="text"], input[type="password"] {
      padding: 8px;
      border: 1px solid #ccc;
      width: 100%; /* Use 100% width to adapt to parent */
      max-width: 350px; /* Optional: set a max-width for very wide screens */
      margin-bottom: 1em;
    }
    button {
      padding: 8px 15px;
      border: 1px solid #555;
      background-color: #e0e0e0;
      cursor: pointer;
    }
    button:hover { background-color: #d0d0d0; }
    button.primary {
      background-color: #337ab7;
      color: white;
      border-color: #2e6da4;
    }
    button.primary:hover { background-color: #286090; }
    button.danger {
        background-color: #f0f0f0;
        color: #d9534f;
        border-color: #ccc;
    }
    button.danger:hover { background-color: #d9534f; color: white; }

    /* Login Screen */
    #login { text-align: center; padding-top: 5vh; }
    #login form {
      display: inline-block;
      text-align: left;
      border: 1px solid #ccc;
      padding: 2em;
      background-color: #fff;
      max-width: 400px;
      width: 90%;
    }
    #err { color: #d9534f; margin-top: 1em; }

    /* Dashboard Specific */
    .progress-bar {
      border: 1px solid #999;
      height: 16px;
      padding: 1px;
    }
    .progress-bar-fill {
      background-color: #555;
      height: 100%;
    }

    /* --- CHANGE 3: Fix the log overflow issue --- */
    #logs-content {
      background-color: #1e1e1e;
      color: #d4d4d4;
      padding: 1em;
      font-size: 0.85em;
      height: 300px;
      overflow: auto;
      white-space: pre-wrap; 
      overflow-wrap: break-word; 
      overflow-x: auto;
      border: 1px solid #ccc;
    }
    .torrent-item, .history-item, .network-item, .service-item, .storage-item, .temp-item {
      border: 1px solid #e0e0e0;
      padding: 0.75em;
      margin-bottom: 0.5em;
    }

    /* Download manager inputs */
    #download-inputs {
        display: flex;
        gap: 10px;
        align-items: flex-end;
    }
    #download-inputs > div {
        flex-grow: 1;
    }

    /* Browse Modal */
    #browse-modal {
      position: fixed;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    #browse-modal > div {
      background-color: #fff;
      padding: 1.5em;
      border: 1px solid #333;
      width: 90%;
      max-width: 600px;
    }
    #browse-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 0.5em;
      margin: 1em 0;
    }
    #browse-list ul { list-style-type: none; padding: 0; margin: 0; }
    #browse-list li { padding: 5px; cursor: pointer; }
    #browse-list li:hover { background-color: #f0f0f0; }


    /* --- CHANGE 4: Add media query for better mobile layout --- */
    @media (max-width: 600px) {
        body {
            padding: 0; /* Remove body padding on mobile */
        }
        .container {
            padding: 1em; /* Reduce container padding */
            border-left: none;
            border-right: none;
        }
        /* Stack download inputs vertically */
        #download-inputs {
            flex-direction: column;
            align-items: stretch;
        }
        #download-inputs > div {
           width: 100%;
        }
    }
  </style>
</head>
<body>

  <div id="login">
    <h2>Admin Login</h2>
    <form id="login-form">
      <label for="u">Username</label><br>
      <input id="u" required><br>
      <label for="p">Password</label><br>
      <input id="p" type="password" required><br>
      <button type="submit" class="primary">Login</button>
      <p id="err"></p>
    </form>
  </div>

  <div id="dash" class="hidden container">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1>{{ app_name }}</h1> <button id="btn-logout">Logout</button>
    </div>
    <hr>

    <fieldset>
        <legend>System Status</legend>
        <div id="status-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); grid-gap: 2em;">
            <div>
                <h3>Services</h3>
                <div id="svc"></div>
            </div>
            <div>
                <h3>Hardware</h3>
                <div>CPU: <span id="cpu">0%</span></div>
                <div class="progress-bar"><div id="cpuBar" class="progress-bar-fill" style="width:0%"></div></div>
                <br>
                <div>Memory: <span id="mem">0%</span></div>
                <div class="progress-bar"><div id="memBar" class="progress-bar-fill" style="width:0%"></div></div>
            </div>
            <div>
                <h3>Temperatures</h3>
                <div id="temps"></div>
            </div>
        </div>
    </fieldset>

    <fieldset>
        <legend>Network & Storage</legend>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); grid-gap: 2em;">
            <div>
                <h3>Network Interfaces</h3>
                <div id="net"></div>
            </div>
            <div>
                <h3>Storage</h3>
                <div id="stg"></div>
            </div>
        </div>
    </fieldset>

    <fieldset>
        <legend>Download Manager</legend>
        <div id="download-inputs">
            <div style="flex-grow: 1;">
                <label for="download-link">Magnet or Video URL</label><br>
                <input id="download-link" placeholder="magnet: or https://..." style="width: 100%;">
            </div>
            <div>
                <label for="dest">Destination</label><br>
                <div style="display: flex;">
                    <input id="dest" value="/Video" style="width: 100%; min-width: 100px; flex-grow: 1;">
                    <button id="btn-browse" style="margin-left: 5px;">Browse</button>
                </div>
            </div>
        </div>
        <br>
        <div>
            <button id="btn-download" class="primary">Download</button>
            <button id="btn-mkdir">Create Folder</button>
        </div>

        <h3>Active Torrents</h3>
        <div id="tx-progress"></div>

        <details>
          <summary style="cursor: pointer; font-weight: bold; margin-top: 1.5em;">History</summary>
          <div id="tx-history"></div>
        </details>
    </fieldset>

    <fieldset>
        <legend>System Logs</legend>
        <button id="btn-refresh-logs">Refresh</button>
        <pre id="logs-content"></pre>
    </fieldset>
  </div>

  <div id="browse-modal" class="hidden">
    <div>
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <h4>Choose Folder</h4>
        <button id="browse-close" style="border:none; background:none; font-size: 2em; line-height: 0.5;">×</button>
      </div>
      <p style="font-size: 0.8em; color: #555;">
        Root: <code id="browse-root-abs"></code><br>
        Current: <code id="browse-cwd">/</code>
      </p>
      <div>
        <input id="browse-path" readonly style="width: calc(100% - 70px);">
        <button id="browse-up">Up</button>
      </div>
      <div id="browse-list"></div>
      <div style="text-align: right; margin-top: 1em;">
        <button id="browse-select" class="primary">Select This Folder</button>
      </div>
    </div>
  </div>

<script>
// --- SCRIPT IS UNCHANGED ---

const loginDiv = document.getElementById('login');
const dashDiv  = document.getElementById('dash');
const errEl    = document.getElementById('err');

async function api(url, opts){
  const r = await fetch(url, opts);
  const t = await r.text();
  let j; try{ j = JSON.parse(t); }catch(e){ throw new Error(t.slice(0,200)); }
  if(!r.ok || j.ok===false || j.success===false) throw new Error(j.error || j.message || ('HTTP '+r.status));
  return j;
}

async function checkStatus(){
  try{
    const s = await api('/auth/status');
    if(s.logged_in){ loginDiv.classList.add('hidden'); dashDiv.classList.remove('hidden'); initDash(); }
  }catch{}
}
checkStatus();

document.getElementById('login-form').addEventListener('submit', async (e)=>{
  e.preventDefault(); errEl.textContent='';
  const username = document.getElementById('u').value;
  const password = document.getElementById('p').value;
  try{
    await api('/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username,password})});
    loginDiv.classList.add('hidden'); dashDiv.classList.remove('hidden'); initDash();
  }catch(ex){ errEl.textContent = ex.message; }
});

document.getElementById('btn-logout').onclick=async()=>{
  await api('/auth/logout',{method:'POST'});
  location.reload();
}

function renderServices(services){
  const el=document.getElementById('svc'); el.innerHTML='';
  for(const [name,state] of Object.entries(services)){
    const row=document.createElement('div');
    row.className = 'service-item';
    // Using a standard checkbox now
    row.innerHTML=`
      <label>
        <input type="checkbox" ${state?'checked':''} data-svc="${name}">
        <span style="text-transform: capitalize;">${name}</span>
      </label>`;
    el.appendChild(row);
  }
  el.querySelectorAll('input[type=checkbox]').forEach(cb=>{
    cb.addEventListener('change',async(ev)=>{
      const service=ev.target.dataset.svc;
      const state=ev.target.checked;
      try{
        await api('/admin/services/toggle',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({service,state})});
      }catch(ex){ alert('Error: '+ex.message); ev.target.checked=!state; }
    });
  });
}

async function initDash(){
  const svc=await api('/admin/services/list');
  renderServices(svc.services);

  const st=await api('/admin/storage');
  const el=document.getElementById('stg'); el.innerHTML='';
  st.storage.forEach(d=>{
    const used=(d.used/1073741824).toFixed(1),tot=(d.total/1073741824).toFixed(1);
    const wrap=document.createElement('div');
    wrap.className = 'storage-item';
    wrap.innerHTML=`
      <div>
        <code>${d.mountpoint}</code> — ${used} / ${tot} GB
      </div>
      <div class="progress-bar"><div class="progress-bar-fill" style="width:${d.percent}%"></div></div>`;
    el.appendChild(wrap);
  });

  const sock=io();
  sock.on('system_stats', (d)=>{
    // CPU & MEM
    document.getElementById('cpu').textContent = d.cpu_percent.toFixed(1)+'%';
    document.getElementById('cpuBar').style.width = d.cpu_percent+'%';
    document.getElementById('mem').textContent = d.memory_percent.toFixed(1)+'%';
    document.getElementById('memBar').style.width = d.memory_percent+'%';

    // TEMPS
    const tempsEl = document.getElementById('temps');
    tempsEl.innerHTML = '';
    (d.temps || []).forEach(t=>{
      const hi = (t.high!=null)?` • high ${t.high.toFixed(0)}°C`:'';
      const cr = (t.critical!=null)?` • crit ${t.critical.toFixed(0)}°C`:'';
      const row = document.createElement('div');
      row.className = 'temp-item';
      row.innerHTML = `
        <div>
          <span>${t.label}: </span>
          <b>${t.current!=null? t.current.toFixed(1)+'°C' : '—'}</b>
        </div>
        <div style="font-size: 0.8em; color: #555;">${hi}${cr}</div>`;
      tempsEl.appendChild(row);
    });
    if (!tempsEl.innerHTML) tempsEl.innerHTML = `<p>No sensors found</p>`;

    // NETWORK
    const netEl = document.getElementById('net');
    netEl.innerHTML = '';
    const ifaces = d.net || {};
    const fmt = (bps)=> {
      if (bps >= 1e9) return (bps/1e9).toFixed(2)+' GB/s';
      if (bps >= 1e6) return (bps/1e6).toFixed(2)+' MB/s';
      if (bps >= 1e3) return (bps/1e3).toFixed(2)+' KB/s';
      return Math.round(bps)+' B/s';
    };
    Object.entries(ifaces).forEach(([name, info])=>{
      const row = document.createElement('div');
      row.className = 'network-item';
      const status = info.isup ? 'UP' : 'DOWN';
      const speed = info.speed_mbps ? `(${info.speed_mbps} Mbps)` : '';
      row.innerHTML = `
        <b>${name} [${status}]</b> ${speed}<br>
        <code>${info.ip || 'no IP address'}</code><br>
        <span>↓ ${fmt(info.rx_bps||0)}</span> |
        <span>↑ ${fmt(info.tx_bps||0)}</span>
      `;
      netEl.appendChild(row);
    });
    if (!netEl.innerHTML) netEl.innerHTML = `<p>No active interfaces</p>`;
  });
}

// ---------- Torrent UI ----------
function renderTorrents(data){
  const list = data.progress || [];
  const el = document.getElementById('tx-progress');
  el.innerHTML = '';
  if (list.length === 0) {
    el.innerHTML = `<p>No active torrent downloads.</p>`;
    return;
  }

  list.forEach(t=>{
    const done  = Number(t.completedLength||0);
    const total = Number(t.totalLength||0);
    const name  = t.name || '(fetching metadata...)';
    const pct   = total>0 ? Math.floor((done/total)*100) : 0;
    const spd   = t.downloadSpeed > 0 ? (Math.round(t.downloadSpeed/1024)+' KB/s') : '';

    const row = document.createElement('div');
    row.className = 'torrent-item';
    row.innerHTML = `
      <div style="display:flex; justify-content: space-between;">
        <div style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 1em;">${name}</div>
        <button class="danger" data-kill="${t.gid}" title="Stop & remove">X</button>
      </div>
      <div class="progress-bar" style="margin-top: 5px;">
        <div class="progress-bar-fill" style="width:${pct}%"></div>
      </div>
      <div style="text-align: right; font-size: 0.9em;">
        ${ total===0 ? '...' : (pct+'%') } @ ${spd}
      </div>
    `;
    el.appendChild(row);
  });

  el.querySelectorAll('[data-kill]').forEach(btn=>{
    btn.onclick = async ()=>{
      if(!confirm('Stop and remove this download?')) return;
      try{
        await api('/admin/torrents/remove',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({gid:btn.dataset.kill})
        });
      }catch(ex){ alert('Error: '+ex.message); }
    };
  });
}


async function loadHistory(){
  try{
    const h=await api('/admin/torrents/history');
    const el=document.getElementById('tx-history'); el.innerHTML='';
    if (h.history.length === 0) {
      el.innerHTML = `<p>History is empty.</p>`;
      return;
    }
    h.history.forEach(it=>{
      const when=new Date((it.completed_at||it.added_at)*1000).toLocaleString();
      const row=document.createElement('div');
      row.className = 'history-item';
      const size=it.size_bytes?(it.size_bytes/1073741824).toFixed(2)+' GB':'';
      row.innerHTML=`
        <div style="display:flex; justify-content: space-between;">
            <div>
              <div>${it.name}</div>
              <div style="font-size: 0.8em; color: #555;">${it.dest} • ${when} ${size?('• '+size):''}</div>
            </div>
            <button class="danger" data-hdel="${it.id}" title="Delete history entry">X</button>
        </div>
      `;
      el.appendChild(row);
    });
    el.querySelectorAll('[data-hdel]').forEach(btn=>{
      btn.onclick=async()=>{
        try{
          await api('/admin/torrents/history/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:Number(btn.dataset.hdel)})});
          loadHistory();
        }catch(ex){ alert('Error: '+ex.message); }
      };
    });
  }catch{}
}

function initTorrentSockets(){
  const sock=io();
  sock.on('torrent_status',(d)=>{ renderTorrents(d); });
}

async function startDownload(){
  const link = document.getElementById('download-link').value.trim();
  const dest = document.getElementById('dest').value.trim();
  if (!link) return alert('Enter a magnet link or video URL');

  let url, body, successMessage;

  if (link.startsWith('magnet:')) {
    url = '/admin/torrents/add';
    body = JSON.stringify({ link, dest });
    successMessage = 'Torrent download started! Progress will appear below.';
  } else if (link.includes('youtube.com') || link.includes('youtu.be')) {
    url = '/admin/youtubedl/add';
    body = JSON.stringify({ link, dest });
    successMessage = 'YouTube download started in the background.';
  } else {
    return alert('Invalid link. Please use a magnet link or a YouTube URL.');
  }

  try {
    await api(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body });
    document.getElementById('download-link').value = '';
    alert(successMessage);
  } catch (ex) {
    alert('Error: ' + ex.message);
  }
}

// ---------- Browse modal ----------
const modal=document.getElementById('browse-modal');
const browsePath=document.getElementById('browse-path');
const browseList=document.getElementById('browse-list');
var historyTimer;

async function browseLoad(path=''){
  const j = await api('/admin/torrents/browse?path='+encodeURIComponent(path));

  document.getElementById('browse-root-abs').textContent = j.root_abs || '';
  document.getElementById('browse-cwd').textContent = j.cwd || '/';
  document.getElementById('browse-path').value = j.cwd || '/';

  const browseList = document.getElementById('browse-list');
  browseList.innerHTML = '';
  const ul = document.createElement('ul');

  if (j.parent && j.cwd !== '/') {
    const liUp = document.createElement('li');
    liUp.innerHTML = `[..] Go up`;
    liUp.onclick = ()=> browseLoad(j.parent);
    ul.appendChild(liUp);
  }

  if (!j.dirs || j.dirs.length === 0) {
    const li = document.createElement('li');
    li.textContent = '(No subfolders)';
    ul.appendChild(li);
  } else {
    j.dirs.forEach(d=>{
      const li=document.createElement('li');
      li.innerHTML=`[D] ${d.name}/`;
      li.onclick=()=> browseLoad(d.path);
      ul.appendChild(li);
    });
  }

  browseList.appendChild(ul);
}

document.getElementById('btn-browse').onclick=()=>{
  modal.classList.remove('hidden');
  browseLoad(document.getElementById('dest').value.trim());
};
document.getElementById('browse-close').onclick=()=>{modal.classList.add('hidden');};
document.getElementById('browse-select').onclick=()=>{
  document.getElementById('dest').value=browsePath.value||'/';
  modal.classList.add('hidden');
};
document.getElementById('browse-up').onclick=async()=>{
  const currentPath = document.getElementById('browse-path').value || '/';
  const j = await api('/admin/torrents/browse?path='+encodeURIComponent(currentPath));
  if (j.parent) browseLoad(j.parent);
};

document.getElementById('btn-mkdir').onclick=async()=>{
  const parent=document.getElementById('dest').value.trim();
  const name=prompt('New folder name?'); if(!name) return;
  try{
    await api('/admin/torrents/mkdir',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({parent,name})});
    alert('Folder created.'); if(!modal.classList.contains('hidden')) browseLoad(parent);
  }catch(ex){ alert('Error: '+ex.message); }
};
document.getElementById('btn-download').onclick=startDownload;

async function loadLogs() {
  const logsContent = document.getElementById('logs-content');
  logsContent.textContent = 'Loading logs...';
  try {
    const data = await api('/admin/logs');
    logsContent.textContent = data.logs || 'No logs yet. Everything is running smoothly!';
    logsContent.scrollTop = logsContent.scrollHeight;
  } catch (ex) {
    logsContent.textContent = 'Error loading logs: ' + ex.message;
  }
}

document.getElementById('btn-refresh-logs').addEventListener('click', loadLogs);

const _initDashOrig = initDash;
initDash = async function () {
  await _initDashOrig();
  initTorrentSockets();
  loadHistory();
  loadLogs();

  if (!historyTimer) {
    historyTimer = setInterval(loadHistory, 5000);
  }
};

</script>
</body>
</html>